<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ƒê·∫∑t Tour - HutechTour</title>

  <!-- Fonts & Icons -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />

  <link 
    href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&family=Playfair+Display:wght@700&display=swap" 
    rel="stylesheet" 
  />
  <link 
    rel="stylesheet" 
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" 
  />
<link rel="stylesheet" href="assets/css/payment.css">

</head>

<body>
  <!-- =====================
       HEADER
       ===================== -->
  <header>
    <div class="top-bar">
      <span>üìû 0123456789 | üïï 6h s√°ng - 11h ƒë√™m</span>
      <div class="socials">
        <a href="#"><img src="assets/images/fb.png" alt=""></a> |
        <a href="#"><img src="assets/images/Zalo.png" alt=""></a> |
        <a href="#"><img src="assets/images/Email.png" alt=""></a>
      </div>
    </div>
    <nav>
      <a href="home.html">
        <h1 class="logo"><img src="assets/images/Htour_logo.png" alt=""> HutechTour</h1>
      </a>
      <ul class="menu">
        <li><a  href="home.html">Home</a></li>
        <li><a href="tours.html" class="active">Tours</a></li>
        <li><a class="homechose" href="#tourSection" class="btn-dattourdattour" id="btndattour">ƒê·∫∑t Tour</a></li>
        <li><button class="showPopupBtn" style="all:unset; cursor:pointer;">Trang</button></li>
        <li><button class="showPopupBtn" style="all:unset; cursor:pointer;">Blog</button></li>
        <li><button class="Btncontact" style="all:unset; cursor:pointer;">Contact</button></li>
      </ul>
    </nav>
  </header>

  <!-- =====================
       WELCOME MARQUEE
       ===================== -->
  <div class="welcome-text">
    <span>Ch√∫c qu√Ω kh√°ch c√≥ m·ªôt chuy·∫øn du l·ªãch th·∫≠t nhi·ªÅu ni·ªÅm vui v√† tr·∫£i nghi·ªám ƒë√°ng nh·ªõ!</span>
  </div>

  <!-- =====================
       N·ªòI DUNG ƒê·∫∂T TOUR
       ===================== -->
  <div class="booking-container">
    <img src="" alt="Tour Image" class="tour-image" id="tourImage" />

    <div class="booking-content">
      <h1 class="tour-title" id="tourTitle"></h1>

      <!-- TH√îNG TIN TOUR -->
      <div class="tour-info">
        <div class="info-section">
          <p>
            <strong>Th·ªùi gian:</strong>
            <span id="tourDuration"></span>
          </p>
          <p>
            <strong>Kh√°ch s·∫°n:</strong>
            <span id="tourHotel"></span>
          </p>
          <p>
            <strong>Ph∆∞∆°ng ti·ªán:</strong>
            <span id="tourTransport"></span>
          </p>
          <p>
            <strong>Gi√° v√© ng∆∞·ªùi l·ªõn:</strong>
            <span id="adultPrice"></span>
          </p>
          <p>
            <strong>Gi√° v√© tr·∫ª em:</strong>
            <span id="childPrice"></span>
          </p>
          <p>
            <strong>S·ªë l∆∞·ª£ng ƒë√£ ƒë·∫∑t:</strong>
            <span class="booked-count" id="bookedCount"></span>
          </p>
        </div>
      </div>

      <!-- FORM ƒê·∫∂T V√â -->
      <div class="booking-form">
        <!-- S·ªê L∆Ø·ª¢NG V√â -->
        <div class="form-group">
          <div>
            <label>V√© ng∆∞·ªùi l·ªõn:</label>
            <input
              type="number"
              id="adultQuantity"
              min="1"
              value="1"
              onchange="updateTotalPrice(); validateBooking(false)"
            />
          </div>
          <div>
            <label>V√© tr·∫ª em (3-12 tu·ªïi):</label>
            <input
              type="number"
              id="childQuantity"
              min="0"
              value="0"
              onchange="updateTotalPrice(); validateBooking(false)"
            />
          </div>
          <div>
            <label>V√© tr·∫ª em d∆∞·ªõi 3 tu·ªïi:</label>
            <input
              type="number"
              id="infantQuantity"
              min="0"
              value="0"
              onchange="updateTotalPrice(); validateBooking(false)"
            />
          </div>
        </div>

        <!-- CH·ªåN NG√ÄY ƒêI -->
        <div class="form-group" style="flex-direction: column; gap: 10px;">
          <label>Ch·ªçn l·ªãch tr√¨nh v√† xem gi√°:</label>
          <div style="display: flex; align-items: center;">
            <div id="startDateOptions"></div>
            <button type="button" id="showAllDatesBtn" style="margin-left: 10px;">
              T·∫•t c·∫£
            </button>
          </div>
          <input type="hidden" id="endDate" />

          <!-- Popup Calendar -->
          <div id="calendarPopup">
            <div
              style="
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 10px;
              "
            >
              <button id="prevMonthBtn">&#8249;</button>
              <span id="calendarMonthYear"></span>
              <button id="nextMonthBtn">&#8250;</button>
            </div>
            <div id="calendarDays">
              <div>T2</div><div>T3</div><div>T4</div><div>T5</div><div>T6</div
              ><div style="color: red">T7</div
              ><div style="color: red">CN</div>
            </div>
            <div id="calendarDates"></div>

            <!-- LEGEND -->
            <div id="calendarLegend">
              <div class="legend-item">
                <div class="box green"></div>
                <span>Ng√†y c√≥ tour</span>
              </div>
              <div class="legend-item">
                <div class="box white"></div>
                <span>Ng√†y kh√¥ng c√≥ tour</span>
              </div>
              <div class="legend-item">
                <div class="box red"></div>
                <span>Cu·ªëi tu·∫ßn / Full</span>
              </div>
            </div>
          </div>

          <!-- C·∫¢NH B√ÅO CH∆ØA CH·ªåN NG√ÄY -->
          <div id="bookingWarnings"></div>
        </div>

        <!-- GI√Å & THANH TO√ÅN -->
        <div class="price-footer">
          <div class="price-info">
            <span class="original-price" id="originalPrice"></span>
            <span class="final-price" id="finalPrice"></span>
          </div>
          <div class="payment-section">
            <select id="paymentMethod">
              <option value="">-- Ch·ªçn ph∆∞∆°ng th·ª©c thanh to√°n --</option>
              <option value="card">Th·∫ª t√≠n d·ª•ng</option>
              <option value="transfer">Chuy·ªÉn kho·∫£n</option>
              <option value="cash">Ti·ªÅn m·∫∑t</option>
            </select>
            <button class="checkout-button" id="checkoutButton" onclick="showWarningPopup()">
              <i class="fas fa-credit-card"></i> Thanh to√°n
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- =====================
       POPUP: C·∫¢NH B√ÅO (Warning)
       ===================== -->
  <div class="popup-overlay" id="warningPopup">
    <div class="popup">
      <h3>‚ö†Ô∏è L∆∞u √Ω quan tr·ªçng</h3>
      <p>V√© kh√¥ng th·ªÉ ho√†n l·∫°i sau khi ƒë·∫∑t. HutechTour r·∫•t ti·∫øc!</p>
      <p id="priceSummary" style="margin-top: 10px; font-weight: bold;"></p>
      <div class="popup-buttons">
        <button class="popup-button cancel" onclick="closeWarningPopup()">
          H·ªßy
        </button>
        <button class="popup-button confirm" onclick="showQRPopup()">
          X√°c nh·∫≠n
        </button>
      </div>
    </div>
  </div>

  <!-- =====================
       POPUP: QR Payment
       ===================== -->
  <div class="popup-overlay" id="qrPopup">
    <div class="popup">
      <h3>Qu√©t m√£ QR ƒë·ªÉ thanh to√°n</h3>
      <div class="qr-code" style="margin: 20px 0;">
        <!-- Thay b·∫±ng ·∫£nh QR th·ª±c -->
        <img src="assets/images/qr-example.png" alt="QR Payment" style="max-width: 200px;" />
      </div>
      <button class="popup-button confirm" onclick="confirmPayment()">
        X√°c nh·∫≠n ƒë√£ thanh to√°n
      </button>
    </div>
  </div>

  <!-- =====================
       POPUP: LOADING
       ===================== -->
       
  <div class="popup-overlay" id="loadingPopup">
    <div class="popup">
      <div style="display: flex; flex-direction: column; align-items: center;">
        <i class="fas fa-spinner fa-spinner-custom" style="font-size: 2em; margin-bottom: 10px;"></i>

        <p>ƒêang x·ª≠ l√Ω thanh to√°n...</p>
      </div>
    </div>
  </div>

  <!-- =====================
       POPUP: SUCCESS
       ===================== -->
  <div class="popup-overlay" id="successPopup">
    <div class="popup">
      <h3>üéâ Thanh to√°n th√†nh c√¥ng!</h3>
      <p>C·∫£m ∆°n qu√Ω kh√°ch ƒë√£ ƒë·∫∑t tour. Ch√∫ng t√¥i s·∫Ω li√™n h·ªá s·ªõm nh·∫•t!</p>
      <div class="popup-buttons">
        <button class="popup-button confirm" onclick="window.location.href='home.html'">
          V·ªÅ trang ch·ªß
        </button>
        <button class="popup-button" onclick="downloadReceipt()">T·∫£i bi√™n lai</button>
      </div>
    </div>
  </div>

  <!-- =====================
       FOOTER
       ===================== -->




       <iframe class="tdx" src="tourdexuat.html" frameborder="0"></iframe>

<section class="commitment">
  <h2>Cam K·∫øt T·ª´ HutechTour</h2>
  <p>
    Ch√∫ng t√¥i cam k·∫øt mang ƒë·∫øn d·ªãch v·ª• ƒë·∫∑t v√© tour du l·ªãch uy t√≠n ‚Äì nhanh ch√≥ng ‚Äì minh b·∫°ch. T·∫•t c·∫£ tour ƒë·ªÅu c√≥ l·ªãch tr√¨nh r√µ r√†ng, gi√° ni√™m y·∫øt kh√¥ng ph√°t sinh v√† ƒë·ªôi ng≈© h·ªó tr·ª£ lu√¥n s·∫µn s√†ng 24/7 ƒë·ªÉ ƒë·ªìng h√†nh c√πng b·∫°n trong m·ªçi h√†nh tr√¨nh.
  </p>
</section>

  <footer>
    <div class="footer-section">
      <div>
        <h4>V·ªÅ ch√∫ng t√¥i</h4>
        <p>
          Website thu·ªôc d·ª± √°n h·ªçc t·∫≠p c·ªßa sinh vi√™n ng√†nh Qu·∫£n tr·ªã Kh√°ch s·∫°n ‚Äì
          Tr∆∞·ªùng ƒê·∫°i h·ªçc C√¥ng ngh·ªá TP.HCM (HUTECH). N∆°i chia s·∫ª ki·∫øn th·ª©c v√†
          tr·∫£i nghi·ªám trong lƒ©nh v·ª±c du l·ªãch v√† kh√°ch s·∫°n.
        </p>
      </div>
      <div>
        <h4>Li√™n h·ªá</h4>
        <p>Tr∆∞·ªùng ƒê·∫°i h·ªçc C√¥ng ngh·ªá TP.HCM (HUTECH)</p>
        <p>üìç 475A ƒêi·ªán Bi√™n Ph·ªß, P.25, Q. B√¨nh Th·∫°nh, TP.HCM</p>
        <p>üìû (028) 5445 7777</p>
        <p>üìß info@hutech.edu.vn</p>
      </div>
    </div>
  </footer>

  <!-- ========================================
       TO√ÄN B·ªò JAVASCRIPT CHO TRANG ƒê·∫∂T TOUR
       ======================================== -->
  <script>
    let currentTour = null;
    let selectedStartDate = ''; // ISO string ng√†y user ch·ªçn
    let tourDates = [];         // M·∫£ng ISO string 3 ng√†y preset
    let calendarYear, calendarMonth;

    // Khi DOM Content Loaded:
    document.addEventListener('DOMContentLoaded', () => {
      loadTourDetails();          // 1. T·∫£i th√¥ng tin tour
      generatePresetTourDates();  // 2. T·∫°o 3 ng√†y preset kh√¥ng tr√πng
      renderPresetButtons();      // 3. Hi·ªÉn th·ªã 3 n√∫t preset
      initCalendar();             // 4. Kh·ªüi t·∫°o (nƒÉm, th√°ng) Calendar
      attachEventHandlers();      // 5. ƒêƒÉng k√Ω event cho Calendar + ‚ÄúT·∫•t c·∫£‚Äù

      // B·∫Øt s·ª± ki·ªán thay ƒë·ªïi s·ªë l∆∞·ª£ng v√© => Update gi√° & validate
      ['adultQuantity', 'childQuantity', 'infantQuantity'].forEach(id => {
        document.getElementById(id).addEventListener('change', () => {
          updateTotalPrice();
          validateBooking(false);
        });
      });
    });

    /* =============================
       1. T·∫¢I TH√îNG TIN TOUR
       ============================= */
    async function loadTourDetails() {
      try {
        // Ki·ªÉm tra xem c√≥ d·ªØ li·ªáu tour trong sessionStorage kh√¥ng
        const storedTour = sessionStorage.getItem('selectedTour');
        let tour = null;

        if (storedTour) {
          tour = JSON.parse(storedTour);
        } else {
          const urlParams = new URLSearchParams(window.location.search);
          const tourId = urlParams.get('id');
          const response = await fetch('assets/data/tours.json');
          const data = await response.json();

          // T√¨m tour trong tourGiamGia ho·∫∑c tourPhoBien
          tour = data.tourGiamGia.find(t => t.id === tourId);
          if (!tour) {
            tour = data.tourPhoBien.find(t => t.id === tourId);
          }
        }

        if (!tour) return; // N·∫øu kh√¥ng t√¨m th·∫•y, d·ª´ng

        currentTour = tour;

        // ƒê·ªï d·ªØ li·ªáu l√™n giao di·ªán
        document.getElementById('tourTitle').textContent = tour.ten;
        document.getElementById('tourImage').src = tour.image;
        document.getElementById('tourDuration').textContent = tour.thoiGian;

        // X√°c ƒë·ªãnh kh√°ch s·∫°n
        let hotelName = '';
        switch (tour.id) {
          case 'phuyen':
            hotelName = 'Kh√°ch s·∫°n S√†i G√≤n Ph√∫ Y√™n';
            break;
          case 'condao':
            hotelName = 'Kh√°ch s·∫°n C√¥n ƒê·∫£o Resort';
            break;
          case 'mangden':
            hotelName = 'Kh√°ch s·∫°n MƒÉng ƒêen';
            break;
          case 'lyson':
            hotelName = 'Kh√°ch s·∫°n L√Ω S∆°n Resort';
            break;
          case 'quynhon':
            hotelName = 'Kh√°ch s·∫°n M∆∞·ªùng Thanh Quy Nh∆°n';
            break;
          case 'mientay':
            hotelName = 'Kh√°ch s·∫°n M∆∞·ªùng Thanh C·∫ßn Th∆°';
            break;
          case 'sapa':
            hotelName = 'Kh√°ch s·∫°n Bamboo Sapa';
            break;
          case 'phanthiet':
            hotelName = 'Kh√°ch s·∫°n M∆∞·ªùng Thanh Phan Thi·∫øt';
            break;
          case 'danang':
            hotelName = 'Kh√°ch s·∫°n M∆∞·ªùng Thanh ƒê√† N·∫µng';
            break;
          default:
            hotelName = 'Kh√°ch s·∫°n 3 sao trung t√¢m';
        }
        document.getElementById('tourHotel').textContent = hotelName;

        // X√°c ƒë·ªãnh ph∆∞∆°ng ti·ªán
        let transport = '';
        switch (tour.id) {
          case 'phuyen':
            transport = 'Xe Mercedes Sprinter 16 ch·ªó';
            break;
          case 'condao':
            transport = 'M√°y bay Vietnam Airlines + Xe du l·ªãch t·∫°i ƒë·∫£o';
            break;
          case 'mangden':
            transport = 'Xe Hyundai Universe 45 ch·ªó';
            break;
          case 'lyson':
            transport = 'T√†u cao t·ªëc + Xe ƒëi·ªán tham quan ƒë·∫£o';
            break;
          case 'quynhon':
            transport = 'Xe Thaco Garden 29 ch·ªó';
            break;
          case 'mientay':
            transport = 'Xe + T√†u du l·ªãch s√¥ng n∆∞·ªõc';
            break;
          case 'sapa':
            transport = 'T√†u h·ªèa + Xe du l·ªãch t·∫°i Sapa';
            break;
          case 'phanthiet':
            transport = 'Xe Samco 35 ch·ªó';
            break;
          case 'danang':
            transport = 'M√°y bay Vietnam Airlines + Xe du l·ªãch t·∫°i ƒê√† N·∫µng';
            break;
          default:
            transport = 'Xe du l·ªãch m√°y l·∫°nh ƒë·ªùi m·ªõi';
        }
        document.getElementById('tourTransport').textContent = transport;

        // Random s·ªë ƒë√£ ƒë·∫∑t
        const randomBooked = Math.floor(Math.random() * 31);
        document.getElementById('bookedCount').textContent = `${randomBooked}/30`;

        // ƒê·∫∑t gi√° v√© l√™n UI
        if (tour.giamGia) {
          document.getElementById('adultPrice').textContent = `${tour.giaMoi} VND`;
          const basePrice = parseInt(tour.giaMoi.replace(/\./g, ''));
          const childCalc = Math.round(basePrice * 0.75).toLocaleString('vi-VN');
          document.getElementById('childPrice').textContent = `${childCalc} VND`;

          document.getElementById('originalPrice').textContent = `Gi√° g·ªëc: ${tour.giaGoc} VND`;
          document.getElementById('finalPrice').textContent = `${tour.giaMoi} VND`;
        } else {
          document.getElementById('adultPrice').textContent = `${tour.gia} VND`;
          const basePrice = parseInt(tour.gia.replace(/\./g, ''));
          const childCalc = Math.round(basePrice * 0.75).toLocaleString('vi-VN');
          document.getElementById('childPrice').textContent = `${childCalc} VND`;

          document.getElementById('finalPrice').textContent = `${tour.gia} VND`;
          document.getElementById('originalPrice').style.display = 'none';
        }

        updateTotalPrice();
      } catch (error) {
        console.error('L·ªói khi t·∫£i th√¥ng tin tour:', error);
      }
    }

    /* =============================
       2. C·∫¨P NH·∫¨T GI√Å T·ªîNG
       ============================= */
    function updateTotalPrice() {
      if (!currentTour) return;
      const adultQty = parseInt(document.getElementById('adultQuantity').value) || 0;
      const childQty = parseInt(document.getElementById('childQuantity').value) || 0;

      let basePrice = currentTour.giamGia
        ? parseInt(currentTour.giaMoi.replace(/\./g, ''))
        : parseInt(currentTour.gia.replace(/\./g, ''));
      let total = adultQty * basePrice + childQty * Math.round(basePrice * 0.75);

      if (currentTour.giamGia) {
        const oldTotal = adultQty * parseInt(currentTour.giaGoc.replace(/\./g, ''));
        document.getElementById('originalPrice').textContent = `Gi√° g·ªëc: ${oldTotal.toLocaleString('vi-VN')} VND`;
      }
      document.getElementById('finalPrice').textContent = `${total.toLocaleString('vi-VN')} VND`;
    }

    /* =============================
       3. VALIDATE ƒê·∫∂T TOUR
       ============================= */
    function validateBooking(checkDates = false) {
      const adultQty = parseInt(document.getElementById('adultQuantity').value) || 0;
      const childQty = parseInt(document.getElementById('childQuantity').value) || 0;

      const bookedText = document.getElementById('bookedCount').textContent.split('/')[0];
      const currentBooked = parseInt(bookedText);
      const remaining = 30 - currentBooked;
      const requested = adultQty + childQty;

      const warnDiv = document.getElementById('bookingWarnings');
      const checkoutBtn = document.getElementById('checkoutButton');
      warnDiv.style.display = 'none';
      warnDiv.textContent = '';
      checkoutBtn.disabled = false;
      checkoutBtn.style.background = '#5d4037';
      checkoutBtn.style.cursor = 'pointer';

      let warnings = [];

      if (!adultQty || adultQty < 1) {
        warnings.push('S·ªë l∆∞·ª£ng v√© ng∆∞·ªùi l·ªõn ph·∫£i ‚â• 1!');
      }
      if (requested > remaining) {
        warnings.push('S·ªë v√© v∆∞·ª£t qu√° s·ªë v√© c√≤n l·∫°i, vui l√≤ng ƒë·∫∑t l·∫°i.');
      }
      if (checkDates && !selectedStartDate) {
        warnings.push('Vui l√≤ng ch·ªçn ng√†y ƒëi!');
      }

      if (warnings.length > 0) {
        warnDiv.style.display = 'block';
        warnDiv.innerHTML = warnings.join('<br>');
        checkoutBtn.disabled = true;
        checkoutBtn.style.background = 'gray';
        checkoutBtn.style.cursor = 'not-allowed';
        return false;
      }
      return true;
    }

    /* =============================
       4. POPUP C·∫¢NH B√ÅO V√Ä THANH TO√ÅN
       ============================= */
    function showWarningPopup() {
      // Ki·ªÉm tra ƒë√£ ch·ªçn ng√†y ch∆∞a
      if (!selectedStartDate) {
        document.getElementById('bookingWarnings').style.display = 'block';
        document.getElementById('bookingWarnings').textContent = 'Vui l√≤ng ch·ªçn ng√†y ƒëi!';
        return;
      }
      if (!validateBooking(true)) return;
      if (!document.getElementById('paymentMethod').value) {
        alert('Vui l√≤ng ch·ªçn ph∆∞∆°ng th·ª©c thanh to√°n!');
        return;
      }

      // T√≠nh ti·ªÅn
      const adultQty = parseInt(document.getElementById('adultQuantity').value) || 0;
      const childQty = parseInt(document.getElementById('childQuantity').value) || 0;
      let adultPrice = 0, childPrice = 0;
      if (currentTour) {
        adultPrice = currentTour.giamGia
          ? parseInt(currentTour.giaMoi.replace(/\./g, ''))
          : parseInt(currentTour.gia.replace(/\./g, ''));
        childPrice = Math.round(adultPrice * 0.75);
      }
      const totalAdult = adultQty * adultPrice;
      const totalChild = childQty * childPrice;
      const total = totalAdult + totalChild;

      // Hi·ªÉn th·ªã trong popup
      const priceSummary = document.getElementById('priceSummary');
      // Chuy·ªÉn "Ng√†y ƒëi" sang format DD/MM/YYYY
      const startFormatted = (() => {
        const parts = selectedStartDate.split('-');
        return `${parts[2]}/${parts[1]}/${parts[0]}`;
      })();
      // Chuy·ªÉn "Ng√†y v·ªÅ" sang format DD/MM/YYYY
      let endISO = document.getElementById('endDate').value;
      let endFormatted = '';
      if (endISO) {
        const parts2 = endISO.split('-');
        endFormatted = `${parts2[2]}/${parts2[1]}/${parts2[0]}`;
      }

      priceSummary.innerHTML = `
        Gi√° v√© ng∆∞·ªùi l·ªõn: ${totalAdult.toLocaleString('vi-VN')} VND<br>
        Gi√° v√© tr·∫ª em: ${totalChild.toLocaleString('vi-VN')} VND<br>
        T·ªïng ti·ªÅn: ${total.toLocaleString('vi-VN')} VND<br>
        Ng√†y ƒëi: ${startFormatted}<br>
        Ng√†y v·ªÅ: ${endFormatted}
      `;
      document.getElementById('warningPopup').style.display = 'flex';
    }

    function closeWarningPopup() {
      document.getElementById('warningPopup').style.display = 'none';
    }

    function showQRPopup() {
      document.getElementById('warningPopup').style.display = 'none';
      document.getElementById('qrPopup').style.display = 'flex';
    }

    function confirmPayment() {
      document.getElementById('qrPopup').style.display = 'none';
      document.getElementById('loadingPopup').style.display = 'flex';
      setTimeout(() => {
        document.getElementById('loadingPopup').style.display = 'none';
        document.getElementById('successPopup').style.display = 'flex';
      }, 3000);
    }

    function downloadReceipt() {
      const receipt = generateReceipt();
      const blob = new Blob([receipt], { type: 'text/plain' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'bien-lai-hutechtour.txt';
      document.body.appendChild(a);
      a.click();
      window.URL.revokeObjectURL(url);
      document.body.removeChild(a);
    }

    function generateReceipt() {
      const adultQty = document.getElementById('adultQuantity').value || 0;
      const childQty = document.getElementById('childQuantity').value || 0;
      const infantQty = document.getElementById('infantQuantity').value || 0;
      const totalPrice = document.getElementById('finalPrice').textContent;
      // Format "Ng√†y ƒëi"
      const startFormatted = (() => {
        const parts = selectedStartDate.split('-');
        return `${parts[2]}/${parts[1]}/${parts[0]}`;
      })();
      // Format "Ng√†y v·ªÅ"
      let endISO = document.getElementById('endDate').value;
      let endFormatted = '';
      if (endISO) {
        const parts2 = endISO.split('-');
        endFormatted = `${parts2[2]}/${parts2[1]}/${parts2[0]}`;
      }

      return `BI√äN LAI ƒê·∫∂T TOUR
===================
Tour: ${currentTour.ten}
Th·ªùi gian: ${currentTour.thoiGian}
Ng√†y ƒëi: ${startFormatted}
Ng√†y v·ªÅ: ${endFormatted}

S·ªë l∆∞·ª£ng v√©:
- Ng∆∞·ªùi l·ªõn: ${adultQty}
- Tr·∫ª em (3-12 tu·ªïi): ${childQty}
- Tr·∫ª em d∆∞·ªõi 3 tu·ªïi: ${infantQty}

Ph∆∞∆°ng th·ª©c thanh to√°n: ${document.getElementById('paymentMethod').value}
T·ªïng ti·ªÅn: ${totalPrice}

-------------------
Ch·ªØ k√Ω: HutechTour
===================`;
    }

    /* =============================
       5. DATEPICKER: T·∫†O 3 NG√ÄY PRESET
       ============================= */
    function generatePresetTourDates() {
      tourDates = [];
      const today = new Date();
      while (tourDates.length < 3) {
        const randOffset = Math.floor(Math.random() * 30) + 1; // random 1‚Äì30 ng√†y sau
        const d = new Date(today);
        d.setDate(d.getDate() + randOffset);
        const iso = d.toISOString().split('T')[0];
        if (!tourDates.includes(iso)) {
          tourDates.push(iso);
        }
      }
      tourDates.sort((a, b) => new Date(a) - new Date(b));
    }

    /* =============================
       6. RENDER 3 N√öT PRESET + 1 N√öT ‚ÄúT·∫•t c·∫£‚Äù
       ============================= */
    function renderPresetButtons() {
      const container = document.getElementById('startDateOptions');
      container.innerHTML = '';
      tourDates.forEach(dateStr => {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.textContent = new Date(dateStr).toLocaleDateString('vi-VN');
        btn.dataset.dateValue = dateStr;
        btn.classList.add('tour-available');
        btn.addEventListener('click', () => {
          clearCalendarSelection();
          selectPresetDate(btn);
        });
        container.appendChild(btn);
      });
    }

    function selectPresetDate(btnElement) {
      document.querySelectorAll('#startDateOptions button').forEach(b => {
        b.classList.remove('selected');
      });
      document.getElementById('calendarPopup').style.display = 'none';
      btnElement.classList.add('selected');
      selectedStartDate = btnElement.dataset.dateValue;
      computeEndDate(selectedStartDate);
      document.getElementById('bookingWarnings').style.display = 'none';
    }

    function computeEndDate(startISO) {
      if (!currentTour) return;
      // Tr√≠ch ‚ÄúN ng√†y‚Äù t·ª´ currentTour.thoiGian
      const timeStr = currentTour.thoiGian;
      const dayMatch = timeStr.match(/(\d+)\s*ng√†y/);
      let daysToAdd = dayMatch ? parseInt(dayMatch[1]) : 0;

      // T·∫°o Date m·ªõi theo local: new Date(year, month-1, day)
      const parts = startISO.split('-');
      const d = new Date(
        parseInt(parts[0]),
        parseInt(parts[1]) - 1,
        parseInt(parts[2])
      );
      d.setDate(d.getDate() + daysToAdd);

      const yyyy = d.getFullYear();
      const mm = String(d.getMonth() + 1).padStart(2, '0');
      const dd = String(d.getDate()).padStart(2, '0');
      document.getElementById('endDate').value = `${yyyy}-${mm}-${dd}`;
    }

    /* =============================
       7. KH·ªûI T·∫†O CALENDAR (th√°ng / nƒÉm hi·ªán t·∫°i)
       ============================= */
    function initCalendar() {
      const today = new Date();
      calendarYear = today.getFullYear();
      calendarMonth = today.getMonth();
      renderCalendar(calendarYear, calendarMonth);
    }

    /* =============================
       8. ƒêƒÇNG K√ù S·ª∞ KI·ªÜN CHO ‚ÄúT·∫•t c·∫£‚Äù V√Ä Calendar
       ============================= */
    function attachEventHandlers() {
      const showAllBtn = document.getElementById('showAllDatesBtn');
      const calPopup = document.getElementById('calendarPopup');
      const prevBtn = document.getElementById('prevMonthBtn');
      const nextBtn = document.getElementById('nextMonthBtn');

      showAllBtn.addEventListener('click', () => {
        // B·ªè ch·ªçn n√∫t preset (n·∫øu c√≥)
        document.querySelectorAll('#startDateOptions button').forEach(b => {
          b.classList.remove('selected');
        });
        // Hi/·∫©n calendarPopup
        calPopup.style.display = (calPopup.style.display === 'block') ? 'none' : 'block';
        renderCalendar(calendarYear, calendarMonth);
      });

      prevBtn.addEventListener('click', () => {
        calendarMonth--;
        if (calendarMonth < 0) {
          calendarMonth = 11;
          calendarYear--;
        }
        renderCalendar(calendarYear, calendarMonth);
      });

      nextBtn.addEventListener('click', () => {
        calendarMonth++;
        if (calendarMonth > 11) {
          calendarMonth = 0;
          calendarYear++;
        }
        renderCalendar(calendarYear, calendarMonth);
      });
    }

    /* =============================
       9. RENDER CALENDAR (T·∫§T C·∫¢ NG√ÄY) V·ªöI ƒêI·ªÄU KI·ªÜN
       ============================= */
    function renderCalendar(year, month) {
      const monthYearEl = document.getElementById('calendarMonthYear');
      monthYearEl.textContent = `${String(month + 1).padStart(2, '0')}/${year}`;

      const datesContainer = document.getElementById('calendarDates');
      datesContainer.innerHTML = '';

      // T√≠nh ng√†y b·∫Øt ƒë·∫ßu (Monday-first) v√† t·ªïng s·ªë ng√†y
      const firstDay = new Date(year, month, 1);
      const lastDay = new Date(year, month + 1, 0);
      const totalDays = lastDay.getDate();
      const startWeekday = (firstDay.getDay() + 6) % 7; // 0=Mon, ‚Ä¶,6=Sun

      // Th√™m √¥ tr·ªëng tr∆∞·ªõc ng√†y 1
      for (let i = 0; i < startWeekday; i++) {
        const emptyDiv = document.createElement('div');
        datesContainer.appendChild(emptyDiv);
      }

      // T·∫°o t·ª´ng ng√†y 1..totalDays
      for (let d = 1; d <= totalDays; d++) {
        // T·∫°o ƒë·ªëi t∆∞·ª£ng ng√†y theo local: new Date(year, month, d)
        const dateObj = new Date(year, month, d);
        const iso = dateObj.toISOString().split('T')[0];
        const weekday = dateObj.getDay(); // 0=CN, 6=T7

        const btn = document.createElement('button');
        btn.textContent = d;
        btn.type = 'button';

        // N·∫øu ng√†y n·∫±m trong tourDates => "Ng√†y c√≥ tour"
        if (tourDates.includes(iso) && weekday !== 0 && weekday !== 6) {
          btn.classList.add('tour-available');
          btn.dataset.dateValue = iso;
          btn.addEventListener('click', () => {
            selectCalendarDate(btn);
          });
        }
        // N·∫øu ng√†y cu·ªëi tu·∫ßn (T7/CN) ho·∫∑c tourDates ch·ª©a nh∆∞ng cu·ªëi tu·∫ßn => full
        else if (weekday === 0 || weekday === 6) {
          btn.classList.add('weekend');
          btn.disabled = true;
        }
        // Ng√†y kh√¥ng c√≥ tour
        else {
          btn.classList.add('no-tour');
          btn.disabled = true;
        }

        datesContainer.appendChild(btn);
      }
    }

function selectCalendarDate(btnEl) {
  document.querySelectorAll('#calendarDates button').forEach(b => {
    b.classList.remove('selected-date');
  });
  btnEl.classList.add('selected-date');

  // C·ªông th√™m 1 ng√†y so v·ªõi ng√†y ch·ªçn g·ªëc
  const parts = btnEl.dataset.dateValue.split('-');
  const year = parseInt(parts[0], 10);
  const month = parseInt(parts[1], 10) - 1;
  const day = parseInt(parts[2], 10);
  const dateObj = new Date(year, month, day);
  dateObj.setDate(dateObj.getDate() + 1);

  const newYear = dateObj.getFullYear();
  const newMonth = String(dateObj.getMonth() + 1).padStart(2, '0');
  const newDay = String(dateObj.getDate()).padStart(2, '0');
  selectedStartDate = `${newYear}-${newMonth}-${newDay}`;

  computeEndDate(selectedStartDate);
  document.getElementById('calendarPopup').style.display = 'none';
  showSelectedDateOutside(selectedStartDate);
  document.getElementById('bookingWarnings').style.display = 'none';
}


    function showSelectedDateOutside(dateStr) {
      const container = document.getElementById('startDateOptions');
      const oldBtn = document.getElementById('selectedDateBtn');
      if (oldBtn) oldBtn.remove();

      const newBtn = document.createElement('button');
      newBtn.id = 'selectedDateBtn';
      newBtn.type = 'button';
      newBtn.textContent = new Date(dateStr).toLocaleDateString('vi-VN');
      newBtn.dataset.dateValue = dateStr;
      newBtn.classList.add('selected', 'tour-available');
      newBtn.style.cursor = 'default';
      container.insertBefore(newBtn, container.firstChild);

      // B·ªè highlight kh·ªèi 3 n√∫t preset (n·∫øu c√≥)
      document.querySelectorAll('#startDateOptions button:not(#selectedDateBtn)').forEach(b => {
        b.classList.remove('selected');
      });
    }

    function clearCalendarSelection() {
      document.querySelectorAll('#calendarDates button').forEach(b => {
        b.classList.remove('selected-date');
      });
      const oldBtn = document.getElementById('selectedDateBtn');
      if (oldBtn) oldBtn.remove();
    }
  </script>
</body>
</html>
